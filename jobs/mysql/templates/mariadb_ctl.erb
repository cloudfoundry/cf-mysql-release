#!/bin/bash -e

export MARIADB_JOB_DIR=/var/vcap/jobs/mysql
RUN_DIR=/var/vcap/sys/run/mysql
datadir=/var/vcap/store/mysql
LOG_DIR=/var/vcap/sys/log/mysql
LOG_FILE=$LOG_DIR/maria-ctl.log
CONFIG_DIR=/etc/mysql
export JOB_INDEX=<%= index %>
STATE_FILE=/var/vcap/store/mysql/state.txt
MYSQL_SERVER_FILE=/var/vcap/packages/mariadb/support-files/mysql.server

case $1 in

  start)
    mkdir -p $LOG_DIR
    date >> $LOG_FILE 2>> $LOG_FILE

    # It is surprisingly hard to get the config file location passed in
    # on the command line to the mysql.server script. This is easier.
    mkdir -p $CONFIG_DIR
    rm -f /etc/my.cnf
    rm -f $CONFIG_DIR/my.cnf
    ln -sf $MARIADB_JOB_DIR/config/my.cnf $CONFIG_DIR/my.cnf

    if ! test -d ${datadir}; then
      mkdir -p ${datadir}
      /var/vcap/packages/mariadb/scripts/mysql_install_db \
             --basedir=/var/vcap/packages/mariadb --user=vcap \
             --datadir=${datadir} >> $LOG_FILE 2>> $LOG_FILE
    fi
    chown -R vcap:vcap ${datadir}

    export GOROOT=/var/vcap/packages/golang
    cd /var/vcap/packages/mariadb_ctrl
    /var/vcap/packages/golang/bin/go run runner.go \
             -logFile=$LOG_FILE \
             -stateFile=$STATE_FILE \
             -mysqlServer=$MYSQL_SERVER_FILE \
             -mysqlUser=<%= p('admin_username')%> \
             -mysqlPassword=<%= p('admin_password')%> \
             -jobIndex=$JOB_INDEX >> $LOG_FILE 2>> $LOG_FILE \
             -numberOfNodes=<%= p('cluster_ips').length %>
      ;;

  stop)
    mkdir -p $LOG_DIR
    date >> $LOG_FILE 2>> $LOG_FILE
    echo "Stopping node $JOB_INDEX" >> $LOG_FILE
    /var/vcap/packages/mariadb/support-files/mysql.server stop >> $LOG_FILE 2>> $LOG_FILE
    ;;

  *)
    echo "Usage: mysql_ctl {start|stop}"
    ;;

esac
