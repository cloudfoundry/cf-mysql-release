#!/bin/bash
set -e -x

<% if p('no_cf') %>
exit 0
<% end %>

cd /var/vcap/packages/acceptance-tests/src/github.com/cloudfoundry-incubator/cf-mysql-acceptance-tests

<%
integration_config = properties.cf.to_h
integration_config[:proxy] = properties.proxy.to_h
integration_config[:timeout_scale] = properties.timeout_scale

integration_config[:org_name] = properties.org_name if properties.org_name
integration_config[:api] = properties.cf.api_url if properties.cf
integration_config[:admin_user] = properties.cf.admin_username if properties.cf
integration_config[:broker_host] = properties.broker.host if properties.broker
if properties.service
  integration_config[:service_name] = properties.service.name
  integration_config[:plans] = properties.service.plans.map do |plan|
    { max_user_connections: properties.service.max_user_connections_default }.merge(plan.to_h)
  end
end
%>

# don't expose passwords
set +x
cat > integration_config.json <<EOF
<%=
require "json"
JSON.dump(integration_config)
%>
EOF
set -x

export GOPATH=/var/vcap/packages/acceptance-tests
export GOROOT=/var/vcap/packages/golang
export PATH=/var/vcap/packages/cli/bin:$GOPATH/bin:$GOROOT/bin:$PWD/bin:$PATH

export CONFIG=$PWD/integration_config.json

<% if p('smoke_tests_only') %>
  bin/test-smoke --noColor
<% else %>
  bin/test-acceptance --noColor
<% end %>
